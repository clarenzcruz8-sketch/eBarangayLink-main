router.post(
  "/payments/verify",
  upload.array("issued_file"),
  (req, res) => {

    const issuedFile = req.files.find(
      f => f.fieldname === "issued_file"
    );
    const issuedBuffer = issuedFile ? issuedFile.buffer : null;

    const {
      payment_id,
      user_id,
      document_type,
      document_request_id
    } = req.body;

    db.beginTransaction(err => {
      if (err) return res.status(500).json(err);

      const updatePayment = `
        UPDATE payments SET status = 'paid'
        WHERE id = ?
      `;

      const insertDocument = `
        INSERT INTO issued_documents
        (user_id, document_type, document_request_id, file)
        VALUES (?, ?, ?, ?)
      `;

      db.query(updatePayment, [payment_id], err => {
        if (err) return db.rollback(() => res.status(500).json(err));

        db.query(
          insertDocument,
          [user_id, document_type, document_request_id, issuedBuffer],
          err => {
            if (err) return db.rollback(() => res.status(500).json(err));

            db.commit(err => {
              if (err) return res.status(500).json(err);
              res.json({ message: "Payment verified & document issued" });
            });
          }
        );
      });
    });
  }
);